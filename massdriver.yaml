schema: draft-07
name: aws-eks-cluster
description: An open source container orchestration platform that automates many of the manual processes involved in deploying, managing, and scaling containerized applications.
source_url: github.com/massdriver-cloud/aws-eks-cluster
access: public
type: bundle

steps:
  - path: src
    provisioner: terraform
  - path: core-services
    provisioner: terraform
  - path: custom-resources
    provisioner: terraform

params:
  examples:
    - __name: Development
      k8s_version: "1.21"
      node_groups:
        - name_suffix: shared
          instance_type: t4g.medium
          min_size: 1
          max_size: 10
    - __name: Production
      k8s_version: "1.21"
      node_groups:
        - name_suffix: shared
          instance_type: c6g.2xlarge
          min_size: 1
          max_size: 10
  required:
    - k8s_version
    - node_groups
    - core_services
  properties:
    observability:
      type: object
      title: Observability
      description: Configure logging and metrics collection and delivery for your entire cluster
      required:
        -  logging
      properties:
        logging:
          type: object
          title: Logging
          description: Configure logging for your cluster
          required:
            - destination
          properties:
            destination:
              type: string
              title: Destination
              description: Where to send logs
              default: "disabled"
              oneOf:
              - title: "OpenSearch (in cluster)"
                const: "opensearch"
              - title: "Disabled"
                const: "disabled"
          dependencies:
            destination:
              oneOf:
                - properties:
                    destination:
                      const: "opensearch"
                    opensearch:
                      type: object
                      title: OpenSearch
                      required:
                        - persistence_size
                        - retention_days
                      properties:
                        persistence_size:
                          type: integer
                          title: Persistence Size GiB
                          description: Size of the persistent volume to use for OpenSearch
                          minimum: 1
                          maximum: 10000
                          default: 10
                        retention_days:
                          type: integer
                          title: Retention Days
                          description: Number of days to retain logs and metrics in an OpenSearch Index
                          minimum: 1
                          maximum: 365
                          default: 7
                  required:
                    - opensearch
                - properties:
                    destination:
                      const: "disabled"
    k8s_version:
      type: string
      title: Kubernetes Version
      description: The version of Kubernetes to run
      enum:
        - "1.19"
        - "1.20"
        - "1.21"
        - "1.22"
    node_groups:
      type: array
      title: Node Groups
      descrition: Node groups to provision
      minItems: 1
      items:
        type: object
        title: Node Group
        description: Definition of a node group
        required:
          - name_suffix
          - instance_type
          - min_size
          - max_size
        properties:
          name_suffix:
            type: string
            title: Name
            description: The name of the node group
            pattern: "[a-z]{1,}[a-z0-9]{0,19}"
            message:
              pattern: Name must be between 1 and 20 lowercase letters or numbers, and must start with a letter.
            default: ""
          min_size:
            type: integer
            title: Minimum Size
            description: Minimum number of instances in the node group
            default: 1
            minimum: 0
          max_size:
            type: integer
            title: Maximum Size
            description: Maximum number of instances in the node group
            default: 10
            minimum: 0
          instance_type:
            title: Instance type
            description: Instance type to use in the node group
            type: string
            oneOf:
              - title: C6G Double Extra Large (8c/16g)
                const: c6g.2xlarge
              - title: C6G Quadruple Extra Large (16c/32g)
                const: c6g.4xlarge
              - title: C6G 16xlarge (64c/128g)
                const: c6g.16xlarge
              - title: C6G Extra Large (4c/8g)
                const: c6g.xlarge
              - title: C6G 12xlarge (48c/96g)
                const: c6g.12xlarge
              - title: C6G Metal (64c/128g)
                const: c6g.metal
              - title: C6G Medium (1c/2g)
                const: c6g.medium
              - title: C6G Large (2c/4g)
                const: c6g.large
              - title: C6G Eight Extra Large (32c/64g)
                const: c6g.8xlarge
              - title: T4G Micro (2c/1g)
                const: t4g.micro
              - title: T4G Large (2c/8g)
                const: t4g.large
              - title: T4G Medium (2c/4g)
                const: t4g.medium
              - title: T4G Small (2c/2g)
                const: t4g.small
              - title: T4G Double Extra Large (8c/32g)
                const: t4g.2xlarge
              - title: T4G Extra Large (4c/16g)
                const: t4g.xlarge
              - title: T4G Nano (2/.5g)
                const: t4g.nano
    core_services:
      type: object
      title: Core Services
      description: Configure core services in Kubernetes for Massdriver to manage
      required: []
      properties:
        enable_ingress:
          type: boolean
          title: Enable Ingress
          description: Enabling this will create an nginx ingress controller in the cluster, allowing internet traffic to flow into web accessible services within the cluster
          default: false
        route53_hosted_zones:
          type: array
          title: Route53 Hosted Zones
          description: Route53 Hosted Zones to associate with this cluster. Enables Kubernetes to automatically manage DNS records and SSL certificates. Hosted Zones can be configured at https://app.massdriver.cloud/dns-zones.
          default: []
          items:
            title: "Route53 Hosted Zone"
            description: ""
            # TODO: Require a HostedZone ARN: arn:aws:route53:::hostedzone/Z0267127WDKJABXSA830 which isnt _quite a standard ARN.
            $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/aws-arn.json
        enable_efs_csi:
          type: boolean
          title: Enable EFS Volume Support
          description: Enabling this will install the AWS EFS storage controller into your cluster, allowing you to provision persistent volumes backed by EFS file systems.
          default: false
      dependencies:
        enable_efs_csi:
          oneOf:
            - properties:
                enable_efs_csi:
                  const: false
            - properties:
                enable_efs_csi:
                  const: true
                storage_class_to_efs_map:
                  type: array
                  title: Storage Classes
                  description: You may optionally specify a storage class name for each EFS file system you would like to use for persistent volumes. In addition, by specifying any EFS volumes here you will limit the provisioner to only be able to create peristent volumes use the listed EFS file systems. By leaving this blank, all file systems are usable.
                  default: []
                  items:
                    type: object
                    title: Storage Class to EFS File System map
                    required:
                      - storage_class_name
                      - efs_arn
                    properties:
                      storage_class_name:
                        type: string
                        title: Storage Class Name
                        description: Unique name for storage class resource for the EFS file system the EKS cluster
                        $ref: https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/k8s-resource-name.json
                      efs_arn:
                        type: string
                        title: EFS File System ARN
                        description: ARN of the EFS file system to map to this storage class in the EKS cluster
                        pattern: ^arn:aws:elasticfilesystem:[a-z0-9-]*:(?:[0-9]{12})?:file-system\/fs-(?:[a-z0-9]+)?$
                        message:
                          pattern: Must be a valid AWS EFS file system ARN


connections:
  required:
    - aws_authentication
    - vpc
  properties:
    aws_authentication:
      $ref: massdriver/aws-iam-role
    vpc:
      $ref: massdriver/aws-vpc

artifacts:
  required:
    - kubernetes_cluster
  properties:
    kubernetes_cluster:
      $ref: massdriver/kubernetes-cluster

ui:
  ui:order:
    - k8s_version
    - node_groups
    - core_services
    - observability
    - "*"
  node_groups:
    items:
      ui:order:
        - name_suffix
        - instance_type
        - min_size
        - max_size
        - "*"
  core_services:
    ui:order:
      - enable_ingress
      - route53_hosted_zones
      - enable_efs_csi
      - storage_class_to_efs_map
      - "*"
    route53_hosted_zones:
      items:
        ui:field: dnsZonesDropdown
        cloud: aws
    storage_class_to_efs_map:
      items:
        ui:order:
          - storage_class_name
          - efs_arn
